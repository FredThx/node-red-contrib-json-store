<script>
  (function() {
    const POSSIBLE_INPUTS = ['msg', 'flow', 'global', 'jsonata'];
    const ACTION_SET = 'set';
    const ACTION_DELETE = 'delete';
    const ACTION_CLEAR = 'clear';
    const POSSIBLE_ACTIONS = [ACTION_SET, ACTION_DELETE, ACTION_CLEAR];
    const DEFAULT_INPUT = 'msg';
    const DEFAULT_ACTION = ACTION_SET;
    const FORM_ROW_SELECTOR = '.form-row';

    RED.nodes.registerType('key-value-input', {
      category: 'function',
      defaults: {
        store: {
          type: 'key-value-store',
          value: ''
        },
        action: {
          value: ACTION_SET,
          required: true,
          validate: value => POSSIBLE_ACTIONS.indexOf(value) > -1
        },
        key: {
          value: 'topic',
          validate(value) {
            return this.action === ACTION_CLEAR ||
              RED.validators.typedInput('keyType')(value);
          }
        },
        keyType: {value: DEFAULT_INPUT},
        keyvalue: {
          value: 'payload',
          validate(value) {
            return this.action !== ACTION_SET ||
              RED.validators.typedInput('keyvalueType')(value);
          }
        },
        keyvalueType: {value: DEFAULT_INPUT},
        name: {value: ''}
      },
      label() {
        return this.name || this.action || 'input';
      },
      labelStyle() {
        return this.name ? 'node_label_italic' : '';
      },
      icon: 'db.png',
      inputs: 1,
      outputs: 1,
      color: '#c162d1',
      oneditprepare() {
        const $nodeInputKey = $('#node-input-key');
        const $nodeInputKeyvalue = $('#node-input-keyvalue');
        const $nodeInputKeyRow = $nodeInputKey.parents(FORM_ROW_SELECTOR);
        const $nodeInputKeyvalueRow = $nodeInputKeyvalue.parents(
          FORM_ROW_SELECTOR);

        const togglers = {
          clear: () => {
            $nodeInputKeyRow.hide();
            $nodeInputKeyvalueRow.hide();
          },
          delete: () => {
            $nodeInputKeyRow.show();
            $nodeInputKeyvalueRow.hide();
          },
          set: () => {
            $nodeInputKeyRow.show();
            $nodeInputKeyvalueRow.show();
          }
        };

        $nodeInputKey
          .typedInput({
            default: this.keyType || DEFAULT_INPUT,
            types: POSSIBLE_INPUTS
          });

        $nodeInputKeyvalue
          .typedInput({
            default: this.keyvalueType || DEFAULT_INPUT,
            types: POSSIBLE_INPUTS
          });

        $('#node-input-action')
          .change(function() {
            togglers[$(this).val()]();
          })
          .val(this.action || DEFAULT_ACTION);
      },
      oneditsave() {
        this.keyType = $('#node-input-key').typedInput('type');
        this.keyvalueType = $('#node-input-keyvalue').typedInput('type');
      }
    });

  }());
</script>

<script type="text/x-red" data-template-name="key-value-input">
  <div class="form-row">
    <label for="node-input-store"><i class="fa fa-database"></i> Store</label>
    <input id="node-input-store"/>
  </div>

  <div class="form-row">
    <label for="node-input-action"><i class="fa fa-cog"></i> Action</label>
    <select id="node-input-action">
      <option value="set">Set</option>
      <option value="delete">Delete</option>
      <option value="clear">Clear</option>
    </select>
  </div>

  <div class="form-row">
    <label for="node-input-key"><i class="fa fa-key"></i> Key</label>
    <input type="text" id="node-input-key" style="width: 70%;"/>
  </div>

  <div class="form-row">
    <label for="node-input-keyvalue"><i class="fa fa-cube"></i> Value</label>
    <input type="text" id="node-input-keyvalue" style="width: 70%;">
  </div>

  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" style="width: 70%;"/>
  </div>

</script>

<script type="text/x-red" data-help-name="key-value-input">
  <p>Description</p>
</script>
